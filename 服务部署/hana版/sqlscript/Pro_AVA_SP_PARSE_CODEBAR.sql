

CREATE PROCEDURE [dbo].[AVA_SP_PARSE_CODEBAR](
	@itemcode nvarchar(30),--???????
	@codebar nvarchar(300), --?????
	@basetype nvarchar(300), --????????
	@baseentry int, --???????
	@baseline int, --?????§Ü?
	@itemCodeQuantity as tp_codebarquantity readonly,
	@code int output,--???????????
	@message nvarchar(300) output --???????
)
As

	Begin
		select @code = 0, @message = 'OK';
---------------------------------------------------------------------------------------------------------------------------------
--????????
--?????????????2018-8-28??????+??????????+????§Ü? 
/*
????????????????????????????????????????????????????????????????????????????????????????????????
?????????????Ñk?????????????14¦Ë?????

*/
		declare @DocEntry nvarchar(20) --??????????
		declare @LineNum  nvarchar(10) --????????????
		declare @Quantity nvarchar(20) --???????????????????????????????????????
		declare @text     nvarchar(200)--??????????????????????????????????????????????????????????????
		declare @QtyPlan  nvarchar(20) --?????????? 
		declare @QtyOpen  nvarchar(20) --????¦Ä??????

		SELECT @ItemCode=(select top 1 ItemCode from OITM where U_CodeBar=(SELECT string  FROM "AVA_SP_SpitString" (@codebar ,'|')where ID=1))
		SELECT @DocEntry=string  FROM "AVA_SP_SpitString" (@codebar ,'|')where ID=2
		SELECT @LineNum =string  FROM "AVA_SP_SpitString" (@codebar ,'|')where ID=3
		SELECT @Quantity=string  FROM "AVA_SP_SpitString" (@codebar ,'|')where ID=4 --???????????????????????????????????????
		set @text=ISNULL(
		          (select top 1 '??????'+cast(DocEntry as nvarchar) 
				   from AVA_WM_OSRP --???? ????
				   where BaseType=@basetype  --??????? ????????
				   and BaseEntry=@BaseEntry  --??????? ??????
				   and DocStatus='O'  --???? ?? O:????????B1??C???????B1;
				   )
				   ,'')

--10???????????ñÔ??§Ý????¦Ê??§Ý???§µ?
IF isnull(@baseline,-1)=-1 
 Begin
   --1001???????????????????§Ö???????????
	if not exists(select 1 from AVA_WM_VIEW_STK1 where DocType = @basetype and DocEntry = @baseentry and ItemCode = @ItemCode)
	   begin
		  select
			 @code = 10001
			,@message = '???:?????????????????????.[CodeBar]'
			return;
		end	

 --1002???????ùn???????????????????2018-10-17 Vic??????
	if  exists(select 1 from 
	           (select ItemCode,SUM(Quantity) as Quantity  --????????????????(??????????????????)??2018-11-15 Vic????
			   ,SUM(OpenQuantity) as OpenQuantity  
			    from AVA_WM_VIEW_STK1 where DocType = @basetype and DocEntry = @baseentry
				group by ItemCode
			    ) W1
	           INNER JOIN (select ItemCode,sum(Quantity) as Quantity from @itemCodeQuantity group by ItemCode) T0 
			    ON W1.ItemCode=T0.ItemCode
	           where  W1.ItemCode = @ItemCode
				and T0.Quantity>=W1.Quantity --?????????????????????????2018-11-15 Vic????
			   )
	   begin
		  select
			 @code = 10002
			,@message =(select top 1 '???:'+T0.ItemCode+'?????????,????????,'
			             +'??????'+cast(cast(T0.Quantity as int) as nvarchar)
						 +',?????'+cast(cast(W1.OpenQuantity as int) as nvarchar)
					    from 
						(select ItemCode,SUM(Quantity) as Quantity  --????????????????(??????????????????)??2018-11-15 Vic????
						,SUM(OpenQuantity) as OpenQuantity  
			             from AVA_WM_VIEW_STK1 where DocType = @basetype and DocEntry = @baseentry
						 group by ItemCode
						 ) W1 
						  INNER JOIN (select ItemCode,sum(Quantity) as Quantity from @itemCodeQuantity group by ItemCode ) T0 
						  ON W1.ItemCode=T0.ItemCode
					    where W1.ItemCode = @ItemCode
						and T0.Quantity>=W1.Quantity --?????????????????????????2018-11-15 Vic????
					    )
					   +'.[CodeBar]'
			return;
		end			   
        --set @QtyPlan=(select cast(cast(sum(Quantity) as numeric(19,2))     as nvarchar) from [AVA_WM_VIEW_STK1] where DocType=@basetype and DocEntry=@BaseEntry and ItemCode = @ItemCode)
		--set @QtyOpen=(select cast(cast(OpenQuantity as numeric(19,2)) as nvarchar) from [AVA_WM_VIEW_STK1] where DocType=@basetype and DocEntry=@BaseEntry and ItemCode = @ItemCode)
		--Vic2018-8-30:??????????????Ñk??????¦Ä??????
		set @QtyPlan=(select cast(cast(sum(OpenQuantity) as int)     as nvarchar) from [AVA_WM_VIEW_STK1] where DocType=@basetype and DocEntry=@BaseEntry and ItemCode = @ItemCode)  

--?????????app??????????????¦²????????????????????????????
	 ----????? ???????????  ????? ?????????????????????????????????????
		 select 'itemCode'as ProName  ,'???????'as ProDesc ,@itemCode as ProValue
		union all
		 select 'barCode' as ProName  ,'???????'  as ProDesc ,@codebar  as ProValue
		union all
		 select 'quantity'as ProName  ,'????????'as ProDesc ,isnull(@Quantity,'1') as ProValue		
        union all--Vic????2018-8-27?????????
		 select 'qtyPlan' as ProName  ,'¦Ä??????'as ProDesc ,isnull(@QtyPlan,'1')  as ProValue  --????§Õ?§³§Õ?????????qtyPlan??????§Õ??qtyplan
		union all--???????????????????????????
		 select 'baseLine'as ProName  ,'??§Ü?'  as ProDesc ,cast(@BaseLine as nvarchar(10)) as ProValue  --?????????????
 End
--20?????????????§Ý???§Ö????
IF @baseline>=0 
 Begin
        set @QtyPlan=(select cast(cast(Quantity as numeric(19,2)) as nvarchar) from [AVA_WM_VIEW_STK1] where DocType=@basetype and DocEntry=@BaseEntry and LineId=@baseline)
		set @QtyOpen=(select cast(cast(OpenQuantity as numeric(19,2)) as nvarchar) from [AVA_WM_VIEW_STK1] where DocType=@basetype and DocEntry=@BaseEntry and LineId=@baseline)  

		--2001???????????????????§Ö???????????
		  if not exists(select 1 from AVA_WM_VIEW_STK1 where DocType = @basetype and DocEntry = @baseentry and LineId = @baseline and ItemCode = @ItemCode)
				begin
					select
					 @code = 20001
					,@message = '???:?????????????§Ö?????????.[CodeBar]'
					return;
				end	
--?????????app??????
	 ----????? ???????????  ????? ?????????????????????????????????????
		 select 'ItemCode'as ProName  ,'???????'as ProDesc ,@itemCode as ProValue
		union all
		 select 'DocEntry'as ProName  ,'???????'as ProDesc ,@DocEntry as ProValue
		union all
		 select 'LineNum' as ProName  ,'??????'  as ProDesc ,@LineNum  as ProValue	
		 union all
		 select 'BarCode' as ProName  ,'???????'  as ProDesc ,@codebar  as ProValue	
		 union all
		 select 'baseDocumentLineId' as ProName  ,'??????'  as ProDesc ,cast(@baseline as nvarchar(4))  as ProValue	
		 union all
		 select 'Quantity'as ProName  ,'????????'as ProDesc ,isnull(@Quantity,'1') as ProValue	
		union all
		 select 'QtyPlan' as ProName  ,'????????'as ProDesc ,isnull(@QtyPlan,'1')  as ProValue
		union all
		 select 'QtyOpen' as ProName  ,'¦Ä??????'as ProDesc ,isnull(@QtyOpen,'1')  as ProValue
		union all
		 select 'Text'    as ProName  ,'???'    as ProDesc ,@text     as ProValue
 End
------------------------------------------------------------------------------------------------------------------	
	End

/*
?????
exec "AVA_SP_PARSE_CODEBAR" null,'046-F','112-20',4014,-1,0,'OK'
*/

GO


